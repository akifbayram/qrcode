# Sanduk

## Project Overview

Multi-user web app for organizing physical storage bins with QR codes. Data persists in SQLite via Express API. iOS 26 Liquid Glass design system.

**Core flows**: Register/login -> Create/join location -> Create bin -> Print QR label -> Scan to find contents.

## Architecture

- **Client**: React 18 + TypeScript 5 (strict) + Vite 5, Tailwind CSS 4, react-router-dom 6 (BrowserRouter)
- **Server**: Express 4, SQLite (better-sqlite3), JWT auth, express-rate-limit
- **Docker**: `api` (Express + SQLite) + `nginx` (frontend + reverse proxy)
- Features live in `src/features/`, server code in `server/src/`, shared types in `src/types.ts`
- **No component library** — all UI primitives hand-rolled in `src/components/ui/`. Do not run `npx shadcn`.

## Code Conventions

- **Git commits**: No "Co-Authored-By" or AI attribution lines.
- **Named exports only** — no default exports except `App.tsx`.
- **Feature hooks pattern**: each feature exposes a hook (e.g. `useBinList`) for data via `apiFetch()` with event-based refresh (`bins-changed` DOM events), and plain async functions (e.g. `addBin`) for mutations. Same file.
- **Data hooks return `{ data, isLoading }`** — e.g. `useBinList()` → `{ bins, isLoading }`.
- **`apiFetch<T>(path, options)`** in `lib/api.ts` — wraps fetch with JWT, auto JSON, FormData support. Throws `ApiError`.
- **`useAuth()`** in `lib/auth.tsx` — `user`, `token`, `activeLocationId`, `login()`, `register()`, `logout()`, `setActiveLocationId()`, `updateUser()`, `deleteAccount()`.
- **Soft deletes**: `DELETE /api/bins/:id` sets `deleted_at`. All bin queries filter `WHERE deleted_at IS NULL`.
- **API response envelopes**: Lists return `{ results: T[], count }`. Errors return `{ error: "CODE", message }` with codes: `VALIDATION_ERROR` (422), `NOT_FOUND` (404), `FORBIDDEN` (403), `CONFLICT` (409), `INTERNAL_ERROR` (500).
- **Snake_case field names** on DB-backed interfaces to match SQLite columns.
- **CSS**: use `var(--token)` design tokens, not raw colors. Glass effects via `glass-card`, `glass-nav`, `glass-heavy`.
- **Responsive**: mobile-first. Breakpoint `lg` (1024px) — bottom nav on mobile, sidebar on desktop.
- **Lazy loading**: All page-level routes use `React.lazy` with `<Suspense>`.
- **`cn()` helper** (clsx + tailwind-merge) for conditional class composition.
- **`addBin()`** takes `{ name, locationId, items?, notes?, tags?, areaId?, icon?, color? }`. `short_code` auto-generated by server.

## API Documentation

OpenAPI spec at `server/openapi.yaml` (source of truth). Update when endpoints change, then copy to `public/api-docs/openapi.yaml`.

## Gotchas

- **Theme**: `localStorage('sanduk-theme')`, applied via `<html class="dark|light">` before first paint. `useTheme()` in `lib/theme.ts` is runtime source of truth.
- **ISO date strings**: All date fields are `string`, not `Date`. SQLite stores as TEXT.
- **`html5-qrcode`** is ~330KB gzipped — always dynamic-import the scanner page.
- **Photos served via API**: `getPhotoUrl(id)` → `/api/photos/${id}/file?token=...` with JWT query param.
- **BrowserRouter**: path-based URLs. QR scanner regex handles both old hash and new path URLs.
- **SQLite db.ts wrapper**: `query()` converts `$1,$2` → `?`, auto-serializes arrays to JSON, auto-deserializes JSON columns. `querySync()` for transactions. `generateUuid()` for all INSERTs.
- **SQLite syntax**: `json_each()` not `unnest()`. `datetime('now')` not `now()`. Error code `SQLITE_CONSTRAINT_UNIQUE` not `23505`.
- **Export backward compat**: Import handles legacy `homeName` field and maps `location` strings to Areas.
- **Route mounting**: Photos upload on bins router (`POST /api/bins/:id/photos`). Export at `/api`. Areas at `/api/locations`.

## Security (non-obvious)

- **JWT secret** auto-generated and persisted to `/data/.jwt_secret` if `JWT_SECRET` env var unset.
- **AI API key encryption**: AES-256-GCM when `AI_ENCRYPTION_KEY` env var set. Graceful fallback to plaintext.

## Verification

```sh
npx tsc --noEmit              # Frontend type check
npx vitest run                # Tests (happy-dom, not jsdom)
npx vite build                # Production build
cd server && npx tsc --noEmit # Server type check
docker compose up -d          # Full stack
```

## Testing

- Vitest 4 + happy-dom. Tests mock `apiFetch` from `@/lib/api` and `useAuth` from `@/lib/auth`.
- Test files in `__tests__/` directories next to feature code.
